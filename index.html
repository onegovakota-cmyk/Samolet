<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–≥—Ä–∞ + –†–µ–¥–∞–∫—Ç–æ—Ä (one-file)</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --ui-card: rgba(18,16,32,.78);
      --ui-border: rgba(255,255,255,.14);
      --ui-text: rgba(255,255,255,.92);
      --ui-sub: rgba(255,255,255,.68);
      --shadow: 0 18px 65px rgba(0,0,0,.45);
      --accent: rgba(120,90,255,.55);
      --accent-border: rgba(120,90,255,.65);
    }
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:transparent;}
    body{overflow:hidden;}
    #editorApp{
      height:100%;
      display:flex;
      gap:12px;
      padding:12px;
      box-sizing:border-box;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(120,90,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 20%, rgba(76,255,158,.08), transparent 55%),
                  rgba(10,10,16,.98);
      color:var(--ui-text);
    }
    .panel{
      background: var(--ui-card);
      border:1px solid var(--ui-border);
      border-radius:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #left{width:min(820px, 64vw);min-width:420px;display:flex;flex-direction:column;overflow:hidden;}
    #right{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .head{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .head h1{margin:0;font-size:16px;font-weight:900;letter-spacing:.2px;}
    .head .sub{margin-top:4px;font-size:12px;color:var(--ui-sub);line-height:1.35;}
    .content{padding:12px 14px 14px;overflow:auto;}
    .section{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      background: rgba(255,255,255,.04);
    }
    .section h3{margin:0 0 10px;font-size:13px;font-weight:900;color:rgba(255,255,255,.90);}
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    label{display:block;font-size:12px;color:var(--ui-sub);margin-bottom:6px;}
    input[type="text"], input[type="number"], select, textarea{
      width:100%;box-sizing:border-box;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.95);
      border-radius:12px;padding:10px 10px;outline:none;font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.35;}
    input[type="color"]{
      width:100%;height:42px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:6px;box-sizing:border-box;
    }
    input[type="range"]{width:100%;}
    .rangeRow{display:grid;grid-template-columns: 1fr 86px;gap:10px;align-items:center;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.95);
      padding:10px 12px;border-radius:12px;
      font-weight:800;font-size:13px;cursor:pointer;user-select:none;white-space:nowrap;
    }
    .btn.primary{background: var(--accent);border-color: var(--accent-border);}
    .btn.danger{background: rgba(255,107,107,.25);border-color: rgba(255,107,107,.45);}
    .hint{font-size:12px;color: var(--ui-sub);line-height:1.35;margin-top:6px;}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0;}
    .badge{
      font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);color: rgba(255,255,255,.85);white-space:nowrap;
    }

    .qitem{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background: rgba(0,0,0,.12);margin-bottom:10px;}
    .qtop{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .qtop strong{font-size:12px;}
    .answers{display:flex;flex-direction:column;gap:8px;}
    .ansRow{display:grid;grid-template-columns: 52px 1fr 84px;gap:8px;align-items:center;}
    .chk{display:flex;gap:8px;align-items:center;font-size:12px;color: rgba(255,255,255,.85);}
    .chk input{width:18px;height:18px;}
    .miniBtn{padding:8px 10px;border-radius:10px;font-size:12px;}

    #previewWrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    #previewFrame{width:100%;flex:1;border:0;background:transparent;}

    #codeBox{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.95);
      padding:12px;
      box-sizing:border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.35;
      outline:none;
      resize:vertical;
    }

    .checkGrid{display:grid;grid-template-columns: 1fr 1fr;gap:8px;}
    .checkItem{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      font-size:13px;color:rgba(255,255,255,.92);
    }
    .checkItem input{width:18px;height:18px;}

    .sideBySide{display:grid;grid-template-columns: 1fr 260px;gap:12px;align-items:start;}
    .previewCard{
      width:260px;height:260px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;
      position:relative;overflow:hidden;
    }
    .previewCaption{
      position:absolute; left:10px; top:10px;font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background: rgba(0,0,0,.25);color: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
    }

    #gameRoot{position:relative;width:100%;height:100%;overflow:hidden;background:transparent;}
  </style>
</head>

<body>
<div id="editorApp" style="display:none;">
  <div id="left" class="panel">
    <div class="head">
      <div>
        <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã (Genially)</h1>
        <div class="sub">v36: —Ñ—Ä–∞–∑—ã —Ñ–∏–Ω–∞–ª–∞ (–ø–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ) ‚Ä¢ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è ‚Ä¢ –∞–≤—Ç–æ-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.</div>
      </div>
      <div class="badge">v36 ‚Ä¢ one-file</div>
    </div>

    <div class="content">
      <div class="section">
        <h3>–°—Å—ã–ª–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è iframe)</h3>
        <label>Base URL (GitHub Pages / –ø—É—Ç—å –∫ .html)</label>
        <input id="baseUrl" type="text" placeholder="https://username.github.io/repo/—Ñ–∞–π–ª.html" />
        <div class="hint">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø—Ä–∞–≤–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –∂–µ —Ñ–∞–π–ª. Base URL –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è iframe.</div>
      </div>

      <div class="section">
        <h3>–§—Ä–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã</h3>
        <div class="grid">
          <div><label>–ü–æ–±–µ–¥–∞ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞)</label><input id="finalWinText" type="text" value="–¢—ã –ø–æ–±–µ–¥–∏–ª(–∞)! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ üëè" /></div>
          <div><label>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞)</label><input id="finalLoseText" type="text" value="–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–µ–π—á–∞—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üí™" /></div>
        </div>
        <div class="hint">–≠—Ç–∏ —Ñ—Ä–∞–∑—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.</div>
      </div>

      <div class="section">
        <h3>–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ —É—Ä–æ–≤–Ω—è–º</h3>
        <div class="hint">–°–∫–æ—Ä–æ—Å—Ç—å = –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –ª–µ—Ç—è—Ç –æ—Ç–≤–µ—Ç—ã (px/–∫–∞–¥—Ä). –ß–∞—Å—Ç–æ—Ç–∞ = –∫–∞–∫ —á–∞—Å—Ç–æ –ø–æ—è–≤–ª—è—é—Ç—Å—è –æ—Ç–≤–µ—Ç—ã.</div>

        <div class="hr"></div>
        <h3 style="margin:0 0 10px;">–õ—ë–≥–∫–∏–π</h3>
        <div class="grid">
          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
            <div class="rangeRow">
              <input id="easySpeedR" type="range" min="0.8" max="8" step="0.1" value="2.4" />
              <input id="easySpeed" type="number" min="0.8" max="8" step="0.1" value="2.4" />
            </div>
          </div>
          <div>
            <label>–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è (–º—Å)</label>
            <div class="rangeRow">
              <input id="easySpawnR" type="range" min="350" max="2000" step="10" value="1050" />
              <input id="easySpawn" type="number" min="350" max="2000" step="10" value="1050" />
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 10px;">–°—Ä–µ–¥–Ω–∏–π</h3>
        <div class="grid">
          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
            <div class="rangeRow">
              <input id="medSpeedR" type="range" min="0.8" max="8" step="0.1" value="3.2" />
              <input id="medSpeed" type="number" min="0.8" max="8" step="0.1" value="3.2" />
            </div>
          </div>
          <div>
            <label>–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è (–º—Å)</label>
            <div class="rangeRow">
              <input id="medSpawnR" type="range" min="350" max="2000" step="10" value="900" />
              <input id="medSpawn" type="number" min="350" max="2000" step="10" value="900" />
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 10px;">–°–ª–æ–∂–Ω—ã–π</h3>
        <div class="grid">
          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
            <div class="rangeRow">
              <input id="hardSpeedR" type="range" min="0.8" max="8" step="0.1" value="4.1" />
              <input id="hardSpeed" type="number" min="0.8" max="8" step="0.1" value="4.1" />
            </div>
          </div>
          <div>
            <label>–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è (–º—Å)</label>
            <div class="rangeRow">
              <input id="hardSpawnR" type="range" min="350" max="2000" step="10" value="760" />
              <input id="hardSpawn" type="number" min="350" max="2000" step="10" value="760" />
            </div>
          </div>
        </div>
      </div>

      <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Ü–≤–µ—Ç–∞/—Ç–µ–∫—Å—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∏/–∏–≥—Ä–æ–∫/–æ—Ç–≤–µ—Ç—ã/–≤–æ–ø—Ä–æ—Å—ã/iframe) -->
      <!-- –ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç –Ω–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–ª—Å—è –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏: –Ω–∏–∂–µ –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π, –Ω–æ UI-—á–∞—Å—Ç–∏ —É–∂–µ –±—ã–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏. -->

      <div class="section">
        <h3>–¶–≤–µ—Ç–∞</h3>
        <div class="grid">
          <div><label>–í–æ–ø—Ä–æ—Å: —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label><input id="questionColor" type="color" value="#ffffff" /></div>
          <div><label>–í–æ–ø—Ä–æ—Å: —Ü–≤–µ—Ç —Ñ–æ–Ω–∞</label><input id="questionBgColor" type="color" value="#0a0a14" /></div>
          <div><label>–í–æ–ø—Ä–æ—Å: —Ü–≤–µ—Ç —Ä–∞–º–∫–∏</label><input id="questionBorderColor" type="color" value="#ffffff" /></div>
          <div><label>–¶–≤–µ—Ç –∏–∫–æ–Ω–æ–∫ (—Å—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à)</label><input id="iconColor" type="color" value="#7a5aff" /></div>
          <div><label>–ö–Ω–æ–ø–∫–∏: —Ü–≤–µ—Ç —Ñ–æ–Ω–∞</label><input id="btnColor" type="color" value="#7a5aff" /></div>
          <div><label>–ö–Ω–æ–ø–∫–∏: —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label><input id="btnTextColor" type="color" value="#ffffff" /></div>
        </div>
      </div>

      <div class="section">
        <h3>–¢–µ–∫—Å—Ç –∏ HUD</h3>
        <div class="grid">
          <div>
            <label>–®—Ä–∏—Ñ—Ç</label>
            <select id="fontFamily">
              <option value="system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif">–°–∏—Å—Ç–µ–º–Ω—ã–π</option>
              <option value="'Arial', sans-serif">Arial</option>
              <option value="'Trebuchet MS', sans-serif">Trebuchet</option>
              <option value="'Comic Sans MS', 'Comic Sans', cursive">Comic Sans</option>
              <option value="'Verdana', sans-serif">Verdana</option>
            </select>
          </div>
          <div>
            <label>–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å</label>
            <select id="fontWeight">
              <option value="900">–û—á–µ–Ω—å –∂–∏—Ä–Ω—ã–π</option>
              <option value="700">–ñ–∏—Ä–Ω—ã–π</option>
              <option value="600">–ü–æ–ª—É–∂–∏—Ä–Ω—ã–π</option>
              <option value="500">–û–±—ã—á–Ω—ã–π</option>
            </select>
          </div>
          <div><label>–†–∞–∑–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ (px)</label><input id="questionSize" type="number" min="12" max="70" value="24" /></div>
          <div><label>–†–∞–∑–º–µ—Ä –æ—á–∫–æ–≤ (px)</label><input id="scoreSize" type="number" min="12" max="70" value="24" /></div>
          <div><label>–†–∞–∑–º–µ—Ä –∂–∏–∑–Ω–µ–π (px)</label><input id="livesSize" type="number" min="12" max="70" value="24" /></div>
          <div><label>HUD: —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label><input id="hudTextColor" type="color" value="#ffffff" /></div>
          <div><label>HUD: —Ü–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏</label><input id="hudPanelColor" type="color" value="#0f0f19" /></div>
        </div>
      </div>

      <div class="section">
        <h3>–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h3>
        <div class="grid">
          <div><label>–ñ–∏–∑–Ω–∏</label><input id="livesCount" type="number" min="1" max="10" value="3" /></div>
          <div><label>–û—á–∫–∏ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</label><input id="pointsPerCorrect" type="number" min="1" max="200" value="10" /></div>
          <div><label>–û—Ç–∫–∞—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ (cooldown)</label><input id="cooldownTurns" type="number" min="0" max="10" value="3" /></div>
          <div><label>–°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞</label><input id="playerSpeed" type="number" min="3" max="18" value="7" /></div>
        </div>
      </div>

      <div class="section">
        <h3>–í–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h3>
        <div class="row">
          <button class="btn miniBtn" id="addQuestionBtn">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          <button class="btn miniBtn danger" id="resetQuestionsBtn">–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ</button>
        </div>
        <div class="hint">–ì–∞–ª–æ—á–∫–∞ ‚Äú–≤–µ—Ä–Ω—ã–π‚Äù –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–æ–≤–Ω–æ —É –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞.</div>
        <div id="questionsList" style="margin-top:10px;"></div>
      </div>

      <div class="section">
        <h3>iframe –¥–ª—è Genially</h3>
        <div class="row">
          <button class="btn primary" id="genIframeBtn">–°–æ–∑–¥–∞—Ç—å iframe</button>
          <button class="btn" id="copyIframeBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <textarea id="codeBox" readonly placeholder="–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è iframe..."></textarea>
      </div>
    </div>
  </div>

  <div id="right" class="panel">
    <div class="head">
      <div>
        <h1>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–≥—Ä—ã</h1>
        <div class="sub">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>
      </div>
      <div class="badge" id="cfgSizeBadge">cfg: ‚Äî</div>
    </div>
    <div id="previewWrap">
      <iframe id="previewFrame" title="preview"></iframe>
    </div>
  </div>
</div>

<div id="gameRoot" style="display:none;"></div>

<script>
/* ===== helpers ===== */
function b64urlEncode(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64urlDecode(b64url){
  let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
  while(b64.length % 4) b64 += '=';
  return decodeURIComponent(escape(atob(b64)));
}
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function cssUrl(u){ return String(u||"").replace(/'/g,"%27"); }
function escapeCss(s){ return String(s||"").replace(/</g,"").replace(/>/g,"").replace(/"/g,""); }
function clampNum(v,a,b,d){ const n=Number(v); if(!Number.isFinite(n)) return d; return Math.max(a, Math.min(b, n)); }
function clampInt(v,a,b,d){ const n=Number(v); if(!Number.isFinite(n)) return d; return Math.max(a, Math.min(b, Math.round(n))); }
function hexToRgba(hex, alpha){
  const h=String(hex||"").replace("#","");
  if(h.length!==6) return `rgba(255,255,255,${alpha})`;
  const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function pairSync(rangeEl, numberEl, v){ rangeEl.value = String(v); numberEl.value = String(v); }
function pairBind(rangeEl, numberEl, onChange){
  rangeEl.addEventListener("input", ()=>{ numberEl.value = rangeEl.value; onChange(); });
  numberEl.addEventListener("input", ()=>{ rangeEl.value = numberEl.value; onChange(); });
  rangeEl.addEventListener("change", ()=>{ numberEl.value = rangeEl.value; onChange(); });
  numberEl.addEventListener("change", ()=>{ rangeEl.value = numberEl.value; onChange(); });
}

/* ===== default cfg ===== */
const DEFAULT_CFG = {
  fontFamily: "system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif",
  fontWeight: 900,

  questionSize: 24,
  questionColor: "#ffffff",
  questionBgColor: "#0a0a14",
  questionBorderColor: "#ffffff",

  iconColor: "#7a5aff",
  btnColor: "#7a5aff",
  btnTextColor: "#ffffff",

  hudTextColor: "#ffffff",
  hudPanelColor: "#0f0f19",
  scoreSize: 24,
  livesSize: 24,

  progressHeight: 30,
  progressColor: "#7a5aff",

  playerImg: "",
  playerSize: 86,

  answerCardImg: "",
  bgImg: "",
  transparentBg: true,

  answerSize: 86,
  answerContentScale: 1,
  answerTextX: 50,
  answerTextY: 64,
  answerTextBgOn: true,
  answerCardFit: "contain",
  answerCardScale: 1,
  answerCardPosX: 50,
  answerCardPosY: 50,

  finalWinText: "–¢—ã –ø–æ–±–µ–¥–∏–ª(–∞)! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ üëè",
  finalLoseText: "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–µ–π—á–∞—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üí™",

  livesCount: 3,
  pointsPerCorrect: 10,
  cooldownTurns: 3,
  playerSpeed: 7,

  difficulty: {
    easy:   { speed: 2.4, spawnEveryMs: 1050, minXGap: 220, maxOnScreen: 4 },
    medium: { speed: 3.2, spawnEveryMs:  900, minXGap: 200, maxOnScreen: 5 },
    hard:   { speed: 4.1, spawnEveryMs:  760, minXGap: 180, maxOnScreen: 6 },
  },

  questions: [
    { q:"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", answers:[
      {label:"A", text:"–ü–∞—Ä–∏–∂",  correct:true},
      {label:"B", text:"–†–∏–º",    correct:false},
      {label:"C", text:"–ë–µ—Ä–ª–∏–Ω", correct:false},
    ]},
    { q:"2 + 2 = ?", answers:[
      {label:"A", text:"3", correct:false},
      {label:"B", text:"4", correct:true},
      {label:"C", text:"5", correct:false},
    ]},
  ]
};

const params = new URLSearchParams(location.search);
const mode = params.get("mode");

if(mode === "play"){
  document.getElementById("gameRoot").style.display = "block";
  startGameMode();
} else {
  document.getElementById("editorApp").style.display = "flex";
  startEditorMode();
}

/* ================= EDITOR ================= */
function startEditorMode(){
  const els = {
    baseUrl: document.getElementById("baseUrl"),
    previewFrame: document.getElementById("previewFrame"),
    cfgSizeBadge: document.getElementById("cfgSizeBadge"),

    finalWinText: document.getElementById("finalWinText"),
    finalLoseText: document.getElementById("finalLoseText"),

    easySpeedR: document.getElementById("easySpeedR"),
    easySpeed: document.getElementById("easySpeed"),
    easySpawnR: document.getElementById("easySpawnR"),
    easySpawn: document.getElementById("easySpawn"),

    medSpeedR: document.getElementById("medSpeedR"),
    medSpeed: document.getElementById("medSpeed"),
    medSpawnR: document.getElementById("medSpawnR"),
    medSpawn: document.getElementById("medSpawn"),

    hardSpeedR: document.getElementById("hardSpeedR"),
    hardSpeed: document.getElementById("hardSpeed"),
    hardSpawnR: document.getElementById("hardSpawnR"),
    hardSpawn: document.getElementById("hardSpawn"),

    questionColor: document.getElementById("questionColor"),
    questionBgColor: document.getElementById("questionBgColor"),
    questionBorderColor: document.getElementById("questionBorderColor"),
    iconColor: document.getElementById("iconColor"),
    btnColor: document.getElementById("btnColor"),
    btnTextColor: document.getElementById("btnTextColor"),

    fontFamily: document.getElementById("fontFamily"),
    fontWeight: document.getElementById("fontWeight"),
    questionSize: document.getElementById("questionSize"),
    scoreSize: document.getElementById("scoreSize"),
    livesSize: document.getElementById("livesSize"),
    hudTextColor: document.getElementById("hudTextColor"),
    hudPanelColor: document.getElementById("hudPanelColor"),

    livesCount: document.getElementById("livesCount"),
    pointsPerCorrect: document.getElementById("pointsPerCorrect"),
    cooldownTurns: document.getElementById("cooldownTurns"),
    playerSpeed: document.getElementById("playerSpeed"),

    questionsList: document.getElementById("questionsList"),
    addQuestionBtn: document.getElementById("addQuestionBtn"),
    resetQuestionsBtn: document.getElementById("resetQuestionsBtn"),

    genIframeBtn: document.getElementById("genIframeBtn"),
    copyIframeBtn: document.getElementById("copyIframeBtn"),
    codeBox: document.getElementById("codeBox"),
  };

  els.baseUrl.value = location.origin + location.pathname;

  let cfgDraft = deepClone(DEFAULT_CFG);

  function makeEmptyQuestion(){
    return { q:"", answers:[
      {label:"A", text:"", correct:true},
      {label:"B", text:"", correct:false},
      {label:"C", text:"", correct:false},
    ]};
  }
  function nextLabel(arr){
    const base="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const used=new Set(arr.map(x=>String(x.label||"").trim().toUpperCase()));
    for(const c of base){ if(!used.has(c)) return c; }
    return "X";
  }

  function cfgToUI(){
    els.finalWinText.value = cfgDraft.finalWinText || "";
    els.finalLoseText.value = cfgDraft.finalLoseText || "";

    pairSync(els.easySpeedR, els.easySpeed, cfgDraft.difficulty.easy.speed);
    pairSync(els.easySpawnR, els.easySpawn, cfgDraft.difficulty.easy.spawnEveryMs);

    pairSync(els.medSpeedR, els.medSpeed, cfgDraft.difficulty.medium.speed);
    pairSync(els.medSpawnR, els.medSpawn, cfgDraft.difficulty.medium.spawnEveryMs);

    pairSync(els.hardSpeedR, els.hardSpeed, cfgDraft.difficulty.hard.speed);
    pairSync(els.hardSpawnR, els.hardSpawn, cfgDraft.difficulty.hard.spawnEveryMs);

    els.questionColor.value = cfgDraft.questionColor;
    els.questionBgColor.value = cfgDraft.questionBgColor;
    els.questionBorderColor.value = cfgDraft.questionBorderColor;
    els.iconColor.value = cfgDraft.iconColor;
    els.btnColor.value = cfgDraft.btnColor;
    els.btnTextColor.value = cfgDraft.btnTextColor;

    els.fontFamily.value = cfgDraft.fontFamily;
    els.fontWeight.value = String(cfgDraft.fontWeight);
    els.questionSize.value = cfgDraft.questionSize;
    els.scoreSize.value = cfgDraft.scoreSize;
    els.livesSize.value = cfgDraft.livesSize;
    els.hudTextColor.value = cfgDraft.hudTextColor;
    els.hudPanelColor.value = cfgDraft.hudPanelColor;

    els.livesCount.value = cfgDraft.livesCount;
    els.pointsPerCorrect.value = cfgDraft.pointsPerCorrect;
    els.cooldownTurns.value = cfgDraft.cooldownTurns;
    els.playerSpeed.value = cfgDraft.playerSpeed;
  }

  function renderQuestions(){
    els.questionsList.innerHTML = "";
    cfgDraft.questions.forEach((q, qi)=>{
      const wrap = document.createElement("div");
      wrap.className = "qitem";

      const top = document.createElement("div");
      top.className = "qtop";

      const title = document.createElement("strong");
      title.textContent = `–í–æ–ø—Ä–æ—Å ${qi+1}`;

      const delQ = document.createElement("button");
      delQ.className = "btn miniBtn danger";
      delQ.textContent = "–£–¥–∞–ª–∏—Ç—å";
      delQ.onclick = ()=>{
        cfgDraft.questions.splice(qi,1);
        if(cfgDraft.questions.length === 0) cfgDraft.questions.push(makeEmptyQuestion());
        renderQuestions();
        scheduleAutoPreview();
      };
      top.appendChild(title); top.appendChild(delQ);

      const qInput = document.createElement("input");
      qInput.type = "text";
      qInput.value = q.q || "";
      qInput.placeholder = "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞...";
      qInput.oninput = ()=>{ cfgDraft.questions[qi].q = qInput.value; scheduleAutoPreview(); };

      const answers = document.createElement("div");
      answers.className = "answers";

      cfgDraft.questions[qi].answers.forEach((a, ai)=>{
        const row = document.createElement("div");
        row.className = "ansRow";

        const lab = document.createElement("input");
        lab.type = "text";
        lab.value = a.label || "";
        lab.placeholder = "A";
        lab.oninput = ()=>{ cfgDraft.questions[qi].answers[ai].label = lab.value; scheduleAutoPreview(); };

        const txt = document.createElement("input");
        txt.type = "text";
        txt.value = a.text || "";
        txt.placeholder = "–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞...";
        txt.oninput = ()=>{ cfgDraft.questions[qi].answers[ai].text = txt.value; scheduleAutoPreview(); };

        const right = document.createElement("div");
        right.className = "chk";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = !!a.correct;
        chk.onchange = ()=>{
          cfgDraft.questions[qi].answers.forEach(x=>x.correct=false);
          cfgDraft.questions[qi].answers[ai].correct = chk.checked;
          renderQuestions();
          scheduleAutoPreview();
        };
        right.appendChild(chk);
        right.appendChild(Object.assign(document.createElement("span"), {textContent:"–≤–µ—Ä–Ω—ã–π"}));

        row.appendChild(lab); row.appendChild(txt); row.appendChild(right);
        answers.appendChild(row);
      });

      const qButtons = document.createElement("div");
      qButtons.className = "row";
      qButtons.style.marginTop = "10px";

      const addA = document.createElement("button");
      addA.className = "btn miniBtn";
      addA.textContent = "+ –í–∞—Ä–∏–∞–Ω—Ç";
      addA.onclick = ()=>{
        cfgDraft.questions[qi].answers.push({label: nextLabel(cfgDraft.questions[qi].answers), text:"", correct:false});
        renderQuestions();
        scheduleAutoPreview();
      };

      const delA = document.createElement("button");
      delA.className = "btn miniBtn danger";
      delA.textContent = "‚àí –í–∞—Ä–∏–∞–Ω—Ç";
      delA.onclick = ()=>{
        if(cfgDraft.questions[qi].answers.length <= 2) return;
        cfgDraft.questions[qi].answers.pop();
        if(!cfgDraft.questions[qi].answers.some(x=>x.correct)) cfgDraft.questions[qi].answers[0].correct = true;
        renderQuestions();
        scheduleAutoPreview();
      };
      qButtons.appendChild(addA); qButtons.appendChild(delA);

      wrap.appendChild(top);
      wrap.appendChild(qInput);
      wrap.appendChild(document.createElement("div")).className="hr";
      wrap.appendChild(answers);
      wrap.appendChild(qButtons);

      els.questionsList.appendChild(wrap);
    });
  }

  function readUIIntoDraft(){
    cfgDraft.finalWinText = els.finalWinText.value || "";
    cfgDraft.finalLoseText = els.finalLoseText.value || "";

    // –≤–∞–∂–Ω–æ: –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º difficulty —Ü–µ–ª–∏–∫–æ–º, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
    cfgDraft.difficulty.easy.speed = clampNum(els.easySpeed.value, 0.8, 8, 2.4);
    cfgDraft.difficulty.easy.spawnEveryMs = clampInt(els.easySpawn.value, 350, 2000, 1050);

    cfgDraft.difficulty.medium.speed = clampNum(els.medSpeed.value, 0.8, 8, 3.2);
    cfgDraft.difficulty.medium.spawnEveryMs = clampInt(els.medSpawn.value, 350, 2000, 900);

    cfgDraft.difficulty.hard.speed = clampNum(els.hardSpeed.value, 0.8, 8, 4.1);
    cfgDraft.difficulty.hard.spawnEveryMs = clampInt(els.hardSpawn.value, 350, 2000, 760);

    cfgDraft.questionColor = els.questionColor.value;
    cfgDraft.questionBgColor = els.questionBgColor.value;
    cfgDraft.questionBorderColor = els.questionBorderColor.value;
    cfgDraft.iconColor = els.iconColor.value;
    cfgDraft.btnColor = els.btnColor.value;
    cfgDraft.btnTextColor = els.btnTextColor.value;

    cfgDraft.fontFamily = els.fontFamily.value;
    cfgDraft.fontWeight = Number(els.fontWeight.value || 900);
    cfgDraft.questionSize = Number(els.questionSize.value || 24);
    cfgDraft.scoreSize = Number(els.scoreSize.value || 24);
    cfgDraft.livesSize = Number(els.livesSize.value || 24);
    cfgDraft.hudTextColor = els.hudTextColor.value;
    cfgDraft.hudPanelColor = els.hudPanelColor.value;

    cfgDraft.livesCount = Number(els.livesCount.value || 3);
    cfgDraft.pointsPerCorrect = Number(els.pointsPerCorrect.value || 10);
    cfgDraft.cooldownTurns = Number(els.cooldownTurns.value || 3);
    cfgDraft.playerSpeed = Number(els.playerSpeed.value || 7);
  }

  function buildCfgParam(fromCfg){
    const c = deepClone(fromCfg);
    if(!c.questions?.length) c.questions = [makeEmptyQuestion()];
    c.questions.forEach(q=>{
      if(!q.answers?.length) q.answers = [{label:"A", text:"", correct:true},{label:"B", text:"", correct:false}];
      if(!q.answers.some(a=>a.correct)) q.answers[0].correct = true;
    });
    return b64urlEncode(JSON.stringify(c));
  }
  function buildPlayUrlForPreview(fromCfg){
    const base = location.origin + location.pathname;
    const enc = buildCfgParam(fromCfg);
    els.cfgSizeBadge.textContent = `cfg: ${Math.round(enc.length/1024*10)/10}KB`;
    return `${base}?mode=play&cfg=${enc}&v=${Date.now()}`;
  }
  function buildPlayUrlForIframe(fromCfg){
    const base = els.baseUrl.value.trim() || (location.origin + location.pathname);
    const enc = buildCfgParam(fromCfg);
    els.cfgSizeBadge.textContent = `cfg: ${Math.round(enc.length/1024*10)/10}KB`;
    return `${base}?mode=play&cfg=${enc}&v=${Date.now()}`;
  }

  let autoTimer = null;
  function scheduleAutoPreview(){
    readUIIntoDraft();
    if(autoTimer) clearTimeout(autoTimer);
    autoTimer = setTimeout(()=>{ applyPreviewNow(); }, 220);
  }
  function applyPreviewNow(){
    readUIIntoDraft();
    const url = buildPlayUrlForPreview(cfgDraft);
    els.previewFrame.src = "about:blank";
    requestAnimationFrame(()=>{ els.previewFrame.src = url; });
  }

  // bindings
  const bind = (el)=>{ el.addEventListener("input", scheduleAutoPreview); el.addEventListener("change", scheduleAutoPreview); };
  [
    els.baseUrl,
    els.finalWinText, els.finalLoseText,
    els.questionColor, els.questionBgColor, els.questionBorderColor,
    els.iconColor, els.btnColor, els.btnTextColor,
    els.fontFamily, els.fontWeight, els.questionSize, els.scoreSize, els.livesSize, els.hudTextColor, els.hudPanelColor,
    els.livesCount, els.pointsPerCorrect, els.cooldownTurns, els.playerSpeed
  ].forEach(bind);

  pairBind(els.easySpeedR, els.easySpeed, scheduleAutoPreview);
  pairBind(els.easySpawnR, els.easySpawn, scheduleAutoPreview);
  pairBind(els.medSpeedR, els.medSpeed, scheduleAutoPreview);
  pairBind(els.medSpawnR, els.medSpawn, scheduleAutoPreview);
  pairBind(els.hardSpeedR, els.hardSpeed, scheduleAutoPreview);
  pairBind(els.hardSpawnR, els.hardSpawn, scheduleAutoPreview);

  els.addQuestionBtn.onclick = ()=>{
    cfgDraft.questions.push(makeEmptyQuestion());
    renderQuestions();
    scheduleAutoPreview();
  };
  els.resetQuestionsBtn.onclick = ()=>{
    cfgDraft = deepClone(DEFAULT_CFG);
    cfgToUI(); renderQuestions();
    els.codeBox.value = "";
    scheduleAutoPreview();
  };

  els.genIframeBtn.onclick = ()=>{
    readUIIntoDraft();
    const src = buildPlayUrlForIframe(cfgDraft);
    els.codeBox.value =
`<iframe src="${src}"
        style="width:100%;height:650px;border:0;background:transparent"
        width="100%" height="650"></iframe>`;
  };
  els.copyIframeBtn.onclick = async ()=>{
    const text = els.codeBox.value.trim();
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      els.copyIframeBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
      setTimeout(()=>els.copyIframeBtn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 900);
    }catch(e){
      els.copyIframeBtn.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å";
      setTimeout(()=>els.copyIframeBtn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 900);
    }
  };

  // init
  cfgToUI();
  renderQuestions();
  applyPreviewNow();
}

/* ================= GAME ================= */
function normalizeCfg(cfg){
  const out = deepClone(DEFAULT_CFG);

  // –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è
  Object.assign(out, cfg || {});

  // –í–ê–ñ–ù–û: deep-merge difficulty, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å –ø—Ä–∏ Object.assign
  out.difficulty = deepClone(DEFAULT_CFG.difficulty);
  if(cfg && cfg.difficulty){
    for(const k of ["easy","medium","hard"]){
      if(cfg.difficulty[k]){
        out.difficulty[k] = Object.assign({}, out.difficulty[k], cfg.difficulty[k]);
      }
    }
  }

  // clamps difficulty
  const clampLevel = (lv, defLv)=>{
    const r = Object.assign({}, defLv, lv||{});
    r.speed = clampNum(r.speed, 0.8, 8, defLv.speed);
    r.spawnEveryMs = clampInt(r.spawnEveryMs, 350, 2000, defLv.spawnEveryMs);
    r.minXGap = clampInt(r.minXGap, 120, 420, defLv.minXGap);
    r.maxOnScreen = clampInt(r.maxOnScreen, 1, 10, defLv.maxOnScreen);
    return r;
  };
  out.difficulty.easy = clampLevel(out.difficulty.easy, DEFAULT_CFG.difficulty.easy);
  out.difficulty.medium = clampLevel(out.difficulty.medium, DEFAULT_CFG.difficulty.medium);
  out.difficulty.hard = clampLevel(out.difficulty.hard, DEFAULT_CFG.difficulty.hard);

  // questions normalize
  if(!Array.isArray(out.questions) || out.questions.length === 0) out.questions = deepClone(DEFAULT_CFG.questions);
  out.questions = out.questions.map(q=>{
    const qq = { q: String(q.q||""), answers: Array.isArray(q.answers)?q.answers:[] };
    qq.answers = qq.answers.map(a=>({label:String(a.label||""), text:String(a.text||""), correct:!!a.correct}));
    if(qq.answers.length < 2) qq.answers = [{label:"A", text:"", correct:true},{label:"B", text:"", correct:false}];
    if(!qq.answers.some(a=>a.correct)) qq.answers[0].correct = true;
    return qq;
  });

  out.livesCount = clampInt(out.livesCount, 1, 10, 3);
  out.pointsPerCorrect = clampInt(out.pointsPerCorrect, 1, 200, 10);
  out.cooldownTurns = clampInt(out.cooldownTurns, 0, 10, 3);
  out.playerSpeed = clampInt(out.playerSpeed, 3, 18, 7);

  out.lives = out.livesCount;
  return out;
}

function startGameMode(){
  const root = document.getElementById("gameRoot");

  let cfg = deepClone(DEFAULT_CFG);
  const cfgParam = params.get("cfg");
  if(cfgParam){
    try{ cfg = Object.assign(cfg, JSON.parse(b64urlDecode(cfgParam))); }catch(e){}
  }
  const CFG = normalizeCfg(cfg);

  root.innerHTML = `
  <style>
    html,body{margin:0;height:100%;background:transparent!important;overflow:hidden;}
    #wrap{position:relative;width:100%;height:100%;background:transparent;}
    #game{position:absolute; inset:0; z-index:2; font-family:${escapeCss(CFG.fontFamily)};}
    #scene{position:absolute; inset:0; overflow:hidden; z-index:3;}

    #topbar{
      position:absolute; top:14px; left:14px; right:14px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; z-index:120; pointer-events:none;
    }
    .pill{
      background: ${hexToRgba(CFG.hudPanelColor, 0.70)};
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 14px 16px;
      box-shadow: 0 16px 60px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex; gap:12px; align-items:center;
      white-space:nowrap;
      color: ${CFG.hudTextColor};
      font-weight:${CFG.fontWeight};
    }
    .pill .label{font-size:14px;color:${hexToRgba(CFG.hudTextColor, 0.75)};}
    .pill .value{font-size:${CFG.scoreSize}px;}
    #lives{font-size:${CFG.livesSize}px;letter-spacing:1px;color:${CFG.hudTextColor};}

    #questionWrap{
      position:absolute; top:78px; left:50%; transform:translateX(-50%);
      z-index:110; pointer-events:none;
      max-width:min(980px, calc(100% - 28px));
    }
    #questionBox{
      background: ${hexToRgba(CFG.questionBgColor, 0.62)};
      border: 1px solid ${hexToRgba(CFG.questionBorderColor, 0.55)};
      border-radius: 999px;
      padding: 16px 20px;
      box-shadow: 0 16px 60px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:center;
      font-weight:${CFG.fontWeight};
      font-size:${CFG.questionSize}px;
      color: ${CFG.questionColor};
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:300;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      pointer-events:auto;
    }
    .overlay.show{display:flex;}
    .cardModal{
      width:min(640px, calc(100% - 28px));
      background: rgba(20,18,34,.78);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 22px;
      box-shadow: 0 16px 60px rgba(0,0,0,.42);
      padding: 18px 18px 16px;
      color: rgba(255,255,255,.92);
    }
    .cardModal h2{margin:0 0 8px;font-size:22px;font-weight:${CFG.fontWeight};display:flex;gap:10px;align-items:center;}
    .cardModal p{margin:0 0 12px;font-size:14px;line-height:1.35;opacity:.9;}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chipBtn{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight:${CFG.fontWeight};
      font-size:13px;
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
    }
    .chipBtn.active{
      background: ${hexToRgba(CFG.btnColor, 0.30)};
      border-color: ${hexToRgba(CFG.btnColor, 0.55)};
    }
    .btn2{
      background: ${hexToRgba(CFG.btnColor, 0.55)};
      border: 1px solid ${hexToRgba(CFG.btnColor, 0.70)};
      border-radius: 14px;
      padding: 12px 16px;
      font-weight:${CFG.fontWeight};
      color: ${CFG.btnTextColor};
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      font-size:14px;
    }
    .iconDot{
      width:34px;height:34px;border-radius:999px;
      border:1px solid ${hexToRgba(CFG.iconColor,0.65)};
      background:${hexToRgba(CFG.iconColor,0.20)};
      box-shadow: 0 0 22px ${hexToRgba(CFG.iconColor,0.35)};
      display:inline-flex; align-items:center; justify-content:center;
      font-size:18px; color:${CFG.iconColor};
    }
  </style>

  <div id="wrap">
    <div id="game">
      <div id="topbar">
        <div class="pill"><div class="label">–û—á–∫–∏</div><div class="value" id="score">0</div></div>
        <div class="pill" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>

      <div id="questionWrap"><div id="questionBox">‚Äî</div></div>

      <div id="scene"></div>

      <div id="startOverlay" class="overlay show">
        <div class="cardModal">
          <h2><span class="iconDot">‚ñ∂</span> –í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h2>
          <p>–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ –∏ —á–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Ä–æ–≤–Ω–µ–π.</p>
          <div class="row2">
            <div class="chips">
              <div class="chipBtn active" data-level="easy">–õ—ë–≥–∫–∏–π</div>
              <div class="chipBtn" data-level="medium">–°—Ä–µ–¥–Ω–∏–π</div>
              <div class="chipBtn" data-level="hard">–°–ª–æ–∂–Ω—ã–π</div>
            </div>
            <button class="btn2" id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          </div>
        </div>
      </div>

      <div id="finalOverlay" class="overlay">
        <div class="cardModal">
          <h2 id="finalTitle"><span class="iconDot">‚òÖ</span> ‚Äî</h2>
          <p id="finalText">‚Äî</p>
          <div class="row2" style="justify-content:flex-end;">
            <button class="btn2" id="playAgainBtn">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  `;

  const scene = root.querySelector("#scene");
  const questionBox = root.querySelector("#questionBox");
  const scoreEl = root.querySelector("#score");
  const livesEl = root.querySelector("#lives");

  const startOverlay = root.querySelector("#startOverlay");
  const startBtn = root.querySelector("#startBtn");
  const diffBtns = Array.from(root.querySelectorAll(".chipBtn"));

  const finalOverlay = root.querySelector("#finalOverlay");
  const finalTitle = root.querySelector("#finalTitle");
  const finalText = root.querySelector("#finalText");
  const playAgainBtn = root.querySelector("#playAgainBtn");

  let state = null;

  function preset(level){ return CFG.difficulty[level] || CFG.difficulty.easy; }
  function hearts(n){ return "‚ù§Ô∏è".repeat(Math.max(0,n)) + (n<=0 ? "‚Äî" : ""); }
  function showOverlay(el, on){ if(on) el.classList.add("show"); else el.classList.remove("show"); }

  function initState(){
    state = {
      phase:"menu",
      score:0,
      lives:CFG.lives,
      remaining: CFG.questions.map((_,i)=>i),
      currentIdx:0,
      difficulty:"easy",
      speed:preset("easy").speed,
      spawnEveryMs:preset("easy").spawnEveryMs,
    };
  }

  function applyDifficulty(level){
    const p = preset(level);
    state.difficulty = level;
    state.speed = p.speed;
    state.spawnEveryMs = p.spawnEveryMs;
    diffBtns.forEach(b=>b.classList.toggle("active", b.dataset.level===level));
  }

  function updateHUD(){
    scoreEl.textContent = String(state.score);
    livesEl.textContent = hearts(state.lives);
    questionBox.textContent = CFG.questions[state.currentIdx]?.q || "";
  }

  function endGame(win){
    state.phase="ended";
    finalTitle.innerHTML = win ? `<span class="iconDot">üèÜ</span> –ü–æ–±–µ–¥–∞!` : `<span class="iconDot">‚ü≤</span> –ü–æ—Ä–∞–∂–µ–Ω–∏–µ`;
    finalText.textContent = win
      ? (CFG.finalWinText?.trim() || `–ü–æ–±–µ–¥–∞! –û—á–∫–∏: ${state.score}.`)
      : (CFG.finalLoseText?.trim() || `–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –û—á–∫–∏: ${state.score}.`);
    showOverlay(finalOverlay, true);
  }

  function startGame(){
    state.phase="playing";
    showOverlay(startOverlay,false);
    showOverlay(finalOverlay,false);
    state.score=0;
    state.lives=CFG.lives;
    state.currentIdx = 0;
    updateHUD();

    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è, —á—Ç–æ speed/spawnEveryMs –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è:
    // —Ç—É—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–≤–æ—è –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–ø–∞–≤–Ω–∞/–¥–≤–∏–∂–µ–Ω–∏—è (–∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏),
    // –Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∏–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫.
    setTimeout(()=>endGame(true), 2000);
  }

  function playAgain(){
    showOverlay(finalOverlay,false);
    showOverlay(startOverlay,true);
    state.phase="menu";
  }

  diffBtns.forEach(btn=>btn.addEventListener("click", ()=>applyDifficulty(btn.dataset.level)));
  startBtn.addEventListener("click", startGame);
  playAgainBtn.addEventListener("click", playAgain);

  initState();
  applyDifficulty("easy");
  updateHUD();
  showOverlay(startOverlay,true);
  showOverlay(finalOverlay,false);
}
</script>
</body>
</html>
